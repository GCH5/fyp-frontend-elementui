import{d as W,k as d,B as se,o as U,e as T,f as l,w as f,C as ne,b as z,j as A,g as m,D as le,x as J,H as Q,J as ie,K as re,L as ue,M as de,N as ce,c as fe,O as ve,p as pe,h as he,P as _e}from"./vendor.41b27b13.js";import{A as ge,a as me}from"./index.7755fa1f.js";import{C as M}from"./installCanvasRenderer.e4c41bf8.js";import{u as X,U as Y,s as G}from"./useEventListener.12456478.js";import{_ as K}from"./index.7e71b667.js";const ye=m(" Set parameters "),we=["element-loading-text","element-loading-svg","element-loading-svg-view-box"],Se=m(" Close Path "),be=m(" Specify queue area "),Ce=m(" Specify finish area "),Pe=m(" Reset "),Ae=m(" Confirm "),ke=m(" Test "),xe=["src"],Ue=W({props:{videoSrc:null,videoUid:null},emits:["parameterStatusChanged"],setup(k,{emit:C}){const y=k,$=500;let i,e,r,t,c=!1,_=!1,g=!1,v,x,P;const a=[],o=[],E=d(),B=d(),w=d(!0),s=d(""),p=d(!1);X(window,"resize",O),X(window,"scroll",O);async function b(){if(!_){alert("Please specify queue area");return}if(!g){alert("Please specify finish area");return}const n={finishAreaPoints:o,queueAreaPoints:a,videoUid:y.videoUid};s.value="   Sending parameters to the server...",w.value=!0;try{const h=await(await fetch(`${M.API_HOST}/queue-analysis/params`,{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify(n)})).json();console.log(h),alert("Parameters set!"),C("parameterStatusChanged",!0)}catch(S){alert(`Response failed with: ${S}`)}w.value=!1}async function q(){_=!0,g=!0,a.push([546.737945608131,384.06417112299465]),a.push([964.4919392594143,637.2192513368983]),a.push([1370.69513124292,309.9465240641711]),a.push([816.2566511896042,62.56684491978609]),o.push([979.8930081497842,648.7700534759358]),o.push([1182.032037335889,773.903743315508]),o.push([1555.5079579273588,428.3422459893048]),o.push([1374.5453984655126,331.1229946524064]),s.value="   Sending parameters to the server...",w.value=!0;const n={finishAreaPoints:o,queueAreaPoints:a,videoUid:y.videoUid};try{const h=await(await fetch(`${M.API_HOST}/queue-analysis/params`,{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify(n)})).json();console.log(h),alert("Parameters set!"),C("parameterStatusChanged",!0)}catch(S){alert(`Response failed with: ${S}`)}w.value=!1}function R(){if(i==="queueArea"){if(a.length<=2){alert("Must be a polygon.");return}if(G({type:"Polygon",coordinates:[[...a,a[a.length-1]]]}).length>0){alert("Must be a polygon."),a.length=0,_=!1,c=!1,i=void 0,t.clearRect(0,0,e.width,e.height);return}_=!0}else{if(o.length<=2){alert("Must be a polygon.");return}if(G({type:"Polygon",coordinates:[[...o,o[o.length-1]]]}).length>0){alert("Must be a polygon."),o.length=0,g=!1,c=!1,i=void 0,t.clearRect(0,0,e.width,e.height);return}g=!0}V(),u(o,!0,"aqua"),u(a,!0,"blue"),c=!1}function I(n){i===void 0||i==="queueArea"&&_||i==="finishArea"&&g||(v=n.offsetX/P.width*e.width,x=n.offsetY/P.height*e.height,c=!0,i==="queueArea"?a.push([v,x]):o.push([v,x]))}function L(n){c&&(V(),i==="queueArea"?(u(o,!0,"aqua"),u(a,!1,"blue")):(u(a,!0,"blue"),u(o,!1,"aqua")),v=n.offsetX/P.width*e.width,x=n.offsetY/P.height*e.height,t.lineTo(v,x),t.stroke())}function u(n,S,h){if(!(n.length<1)){t.strokeStyle=h,t.beginPath(),t.moveTo(n[0][0],n[0][1]);for(let j=1;j<n.length;j++){const[N,F]=n[j];t.lineTo(N,F)}S&&(t.closePath(),t.stroke())}}se(()=>y.videoSrc,()=>{w.value=!0});async function D(){E.value&&(r=E.value,await r.play(),r.pause(),e.height=r.videoHeight,e.width=r.videoWidth,t.lineWidth=r.videoWidth/$,O(),w.value=!1)}function O(){t.clearRect(0,0,e.width,e.height),P=e.getBoundingClientRect(),H()}function V(){t.clearRect(0,0,e.width,e.height),t.drawImage(r,0,0,e.width,e.height)}function ee(){if(!g&&o.length>0){alert("Please complete finish area!");return}i="queueArea",V(),u(o,!0,"aqua"),u(a,!0,"blue"),t.strokeStyle="blue"}function te(){if(!_&&a.length>0){alert("Please complete queue area!");return}i="finishArea",V(),u(o,!0,"aqua"),u(a,!0,"blue"),t.strokeStyle="aqua"}function H(){o.length=0,a.length=0,_=!1,g=!1,c=!1,i=void 0}function ae(){H(),t.clearRect(0,0,e.width,e.height),C("parameterStatusChanged",!1)}async function oe(){if(y.videoSrc.length===0){alert("Please upload a video!");return}p.value=!0,s.value="Loading video...",await le(),!(g&&_)&&(e=B.value,t=e.getContext("2d"),w.value||(P=e.getBoundingClientRect()))}return(n,S)=>{const h=J,j=Q,N=ie;return U(),T("div",null,[l(h,{onClick:oe},{default:f(()=>[ye]),_:1}),l(j,{modelValue:p.value,"onUpdate:modelValue":S[0]||(S[0]=F=>p.value=F),width:"80%",title:"Set parameters"},{default:f(()=>[ne((U(),T("div",{"element-loading-text":s.value,"element-loading-svg":z(Y).content,"element-loading-svg-view-box":z(Y).viewbox},[l(h,{onClick:R},{default:f(()=>[Se]),_:1}),l(h,{type:"primary",round:"",onClick:ee},{default:f(()=>[be]),_:1}),l(h,{type:"primary",round:"",onClick:te},{default:f(()=>[Ce]),_:1}),l(h,{type:"primary",round:"",onClick:ae},{default:f(()=>[Pe]),_:1}),l(h,{type:"primary",round:"",onClick:b},{default:f(()=>[Ae]),_:1}),l(h,{id:"testButton",type:"primary",round:"",onClick:q},{default:f(()=>[ke]),_:1}),A("div",null,[A("canvas",{id:"drawBorderCanvas",ref_key:"canvasElt",ref:B,onMousedown:I,onMousemove:L},null,544),A("video",{id:"sourceVideo",ref_key:"videoEltRef",ref:E,src:k.videoSrc,muted:"",onLoadeddata:D},null,40,xe)])],8,we)),[[N,w.value]])]),_:1},8,["modelValue"])])}}});var qe=K(Ue,[["__scopeId","data-v-0c6186c2"]]);const Z=k=>(pe("data-v-d2d0217a"),k=k(),he(),k),Re={key:0},Le=Z(()=>A("div",{class:"el-upload__text"},[m(" Drop file here or "),A("em",null,"click to upload")],-1)),Te=Z(()=>A("div",{class:"el-upload__tip"}," video files with a size less than 500kb ",-1)),Ee=m(" Process "),Ie=m(" Preview "),je=["src"],$e={key:1},Be={key:2},De=m(" Processing video... "),Ve=W({setup(k){const C=d(),y=d(""),$=d(""),i=d(0),e=d(0),r=d("initial"),t=d(!1),c=d(!1),_=d(),g=d([]);let v;re(()=>{c.value&&URL.revokeObjectURL(y.value)});function x(s){_.value.pause(),s()}function P(s){t.value=s}async function a(){r.value="uploading";const s=new FormData;s.set("video",v,`${i.value}.${v.name.split(".").pop()}`);const p=await me({url:`${M.API_HOST}/queue-analysis/video-upload`,data:s,method:"post",responseType:"arraybuffer",onUploadProgress:function(u){const D=u.loaded/u.total*100|0;e.value=D,D===100&&(r.value="processing")}}),b=parseInt(p.headers["json-size"]),q=p.data,R=new Uint8Array(q,0,b),I=new Uint8Array(q,b),L=new Blob([I]);$.value=URL.createObjectURL(L),g.value=JSON.parse(new TextDecoder("utf-8").decode(R)),r.value="finished"}function o(){if(!v){alert("Please upload a video!");return}c.value=!c.value}const E=s=>{var p,b;(p=C.value)==null||p.clearFiles(),(b=C.value)==null||b.handleStart(s[0])},B=()=>{var s;if(!v){alert("Please upload a video!");return}if(!t.value){alert("Parameters must be set!");return}(s=C.value)==null||s.submit()};function w(s,p){c.value&&URL.revokeObjectURL(y.value),c.value=!1,v=s.raw,i.value=v.uid,y.value=URL.createObjectURL(v)}return(s,p)=>{const b=ue,q=de,R=J,I=Q,L=ce;return U(),T("div",null,[r.value==="initial"?(U(),T("div",Re,[l(q,{ref_key:"upload",ref:C,accept:"video/*",class:"upload-demo",drag:"",limit:1,"on-exceed":E,"on-change":w,"auto-upload":!1,"http-request":a,action:"#"},{default:f(()=>[A("div",null,[l(b,{class:"el-icon--upload"},{default:f(()=>[l(z(_e))]),_:1}),Le])]),_:1},512),Te,l(R,{type:"primary",round:"",onClick:B},{default:f(()=>[Ee]),_:1}),l(R,{type:"primary",round:"",onClick:o},{default:f(()=>[Ie]),_:1}),l(I,{modelValue:c.value,"onUpdate:modelValue":p[0]||(p[0]=u=>c.value=u),width:"95%",title:"Preview","before-close":x},{default:f(()=>[A("video",{id:"videoPreview",ref_key:"videoElt",ref:_,src:y.value,controls:""},null,8,je)]),_:1},8,["modelValue"]),l(qe,{"video-src":y.value,"video-uid":i.value,onParameterStatusChanged:P},null,8,["video-src","video-uid"])])):r.value==="uploading"?(U(),T("div",$e,[l(L,{type:"circle",percentage:e.value,indeterminate:!0},null,8,["percentage"])])):r.value==="processing"?(U(),T("div",Be,[l(L,{type:"line",percentage:50,indeterminate:!0,"stroke-width":20,duration:5},{default:f(()=>[De]),_:1})])):r.value==="finished"?(U(),fe(ge,{key:3,"results-video-src":$.value,"results-data":g.value},null,8,["results-video-src","results-data"])):ve("",!0)])}}});var He=K(Ve,[["__scopeId","data-v-d2d0217a"]]);export{He as default};
