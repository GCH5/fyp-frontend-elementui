import{_ as Y,d as J,r as d,i as se,o as q,c as T,f as l,w as f,j as ne,u as z,a as k,g as m,n as le,E as G,k as ie,l as re,p as ue,q as de,s as ce,t as fe}from"./index.789e35e4.js";import{E as ve,a as pe,A as he,b as _e,u as ge}from"./index.6615ec89.js";import{C as M,E as K,a as me}from"./installCanvasRenderer.0c8cfbbc.js";import{u as W,U as Q,s as X}from"./useEventListener.c2931d63.js";const ye=m(" Set parameters "),we=["element-loading-text","element-loading-svg","element-loading-svg-view-box"],Se=m(" Close Path "),Ae=m(" Specify queue area "),Pe=m(" Specify finish area "),Ce=m(" Reset "),ke=m(" Confirm "),be=m(" Test "),Ue=["src"],qe=J({props:{videoSrc:null,videoUid:null},emits:["parameterStatusChanged"],setup(b,{emit:P}){const y=b,V=500;let i,e,r,t,c=!1,_=!1,g=!1,v,U,C;const a=[],o=[],I=d(),B=d(),w=d(!0),s=d(""),p=d(!1);W(window,"resize",j),W(window,"scroll",j);async function A(){if(!_){alert("Please specify queue area");return}if(!g){alert("Please specify finish area");return}const n={finishAreaPoints:o,queueAreaPoints:a,videoUid:y.videoUid};s.value="   Sending parameters to the server...",w.value=!0;try{const h=await(await fetch(`${M.API_HOST}/queue-analysis/params`,{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify(n)})).json();console.log(h),alert("Parameters set!"),P("parameterStatusChanged",!0)}catch(S){alert(`Response failed with: ${S}`)}w.value=!1}async function x(){_=!0,g=!0,a.push([546.737945608131,384.06417112299465]),a.push([964.4919392594143,637.2192513368983]),a.push([1370.69513124292,309.9465240641711]),a.push([816.2566511896042,62.56684491978609]),o.push([979.8930081497842,648.7700534759358]),o.push([1182.032037335889,773.903743315508]),o.push([1555.5079579273588,428.3422459893048]),o.push([1374.5453984655126,331.1229946524064]),s.value="   Sending parameters to the server...",w.value=!0;const n={finishAreaPoints:o,queueAreaPoints:a,videoUid:y.videoUid};try{const h=await(await fetch(`${M.API_HOST}/queue-analysis/params`,{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify(n)})).json();console.log(h),alert("Parameters set!"),P("parameterStatusChanged",!0)}catch(S){alert(`Response failed with: ${S}`)}w.value=!1}function E(){if(i==="queueArea"){if(a.length<=2){alert("Must be a polygon.");return}if(X({type:"Polygon",coordinates:[[...a,a[a.length-1]]]}).length>0){alert("Must be a polygon."),a.length=0,_=!1,c=!1,i=void 0,t.clearRect(0,0,e.width,e.height);return}_=!0}else{if(o.length<=2){alert("Must be a polygon.");return}if(X({type:"Polygon",coordinates:[[...o,o[o.length-1]]]}).length>0){alert("Must be a polygon."),o.length=0,g=!1,c=!1,i=void 0,t.clearRect(0,0,e.width,e.height);return}g=!0}O(),u(o,!0,"aqua"),u(a,!0,"blue"),c=!1}function L(n){i===void 0||i==="queueArea"&&_||i==="finishArea"&&g||(v=n.offsetX/C.width*e.width,U=n.offsetY/C.height*e.height,c=!0,i==="queueArea"?a.push([v,U]):o.push([v,U]))}function R(n){c&&(O(),i==="queueArea"?(u(o,!0,"aqua"),u(a,!1,"blue")):(u(a,!0,"blue"),u(o,!1,"aqua")),v=n.offsetX/C.width*e.width,U=n.offsetY/C.height*e.height,t.lineTo(v,U),t.stroke())}function u(n,S,h){if(!(n.length<1)){t.strokeStyle=h,t.beginPath(),t.moveTo(n[0][0],n[0][1]);for(let $=1;$<n.length;$++){const[F,N]=n[$];t.lineTo(F,N)}S&&(t.closePath(),t.stroke())}}se(()=>y.videoSrc,()=>{w.value=!0});async function D(){I.value&&(r=I.value,await r.play(),r.pause(),e.height=r.videoHeight,e.width=r.videoWidth,t.lineWidth=r.videoWidth/V,j(),w.value=!1)}function j(){t.clearRect(0,0,e.width,e.height),C=e.getBoundingClientRect(),H()}function O(){t.clearRect(0,0,e.width,e.height),t.drawImage(r,0,0,e.width,e.height)}function ee(){if(!g&&o.length>0){alert("Please complete finish area!");return}i="queueArea",O(),u(o,!0,"aqua"),u(a,!0,"blue"),t.strokeStyle="blue"}function te(){if(!_&&a.length>0){alert("Please complete queue area!");return}i="finishArea",O(),u(o,!0,"aqua"),u(a,!0,"blue"),t.strokeStyle="aqua"}function H(){o.length=0,a.length=0,_=!1,g=!1,c=!1,i=void 0}function ae(){H(),t.clearRect(0,0,e.width,e.height),P("parameterStatusChanged",!1)}async function oe(){if(y.videoSrc.length===0){alert("Please upload a video!");return}p.value=!0,s.value="Loading video...",await le(),!(g&&_)&&(e=B.value,t=e.getContext("2d"),w.value||(C=e.getBoundingClientRect()))}return(n,S)=>{const h=G,$=K,F=me;return q(),T("div",null,[l(h,{onClick:oe},{default:f(()=>[ye]),_:1}),l($,{modelValue:p.value,"onUpdate:modelValue":S[0]||(S[0]=N=>p.value=N),width:"80%",title:"Set parameters"},{default:f(()=>[ne((q(),T("div",{"element-loading-text":s.value,"element-loading-svg":z(Q).content,"element-loading-svg-view-box":z(Q).viewbox},[l(h,{onClick:E},{default:f(()=>[Se]),_:1}),l(h,{type:"primary",round:"",onClick:ee},{default:f(()=>[Ae]),_:1}),l(h,{type:"primary",round:"",onClick:te},{default:f(()=>[Pe]),_:1}),l(h,{type:"primary",round:"",onClick:ae},{default:f(()=>[Ce]),_:1}),l(h,{type:"primary",round:"",onClick:A},{default:f(()=>[ke]),_:1}),l(h,{id:"testButton",type:"primary",round:"",onClick:x},{default:f(()=>[be]),_:1}),k("div",null,[k("canvas",{id:"drawBorderCanvas",ref_key:"canvasElt",ref:B,onMousedown:L,onMousemove:R},null,544),k("video",{id:"sourceVideo",ref_key:"videoEltRef",ref:I,src:b.videoSrc,muted:"",onLoadeddata:D},null,40,Ue)])],8,we)),[[F,w.value]])]),_:1},8,["modelValue"])])}}});var xe=Y(qe,[["__scopeId","data-v-0c6186c2"]]);const Z=b=>(ce("data-v-d2d0217a"),b=b(),fe(),b),Ee={key:0},Re=Z(()=>k("div",{class:"el-upload__text"},[m(" Drop file here or "),k("em",null,"click to upload")],-1)),Te=Z(()=>k("div",{class:"el-upload__tip"}," video files with a size less than 500kb ",-1)),Ie=m(" Process "),Le=m(" Preview "),$e=["src"],Ve={key:1},Be={key:2},De=m(" Processing video... "),Oe=J({setup(b){const P=d(),y=d(""),V=d(""),i=d(0),e=d(0),r=d("initial"),t=d(!1),c=d(!1),_=d(),g=d([]);let v;ie(()=>{c.value&&URL.revokeObjectURL(y.value)});function U(s){_.value.pause(),s()}function C(s){t.value=s}async function a(){r.value="uploading";const s=new FormData;s.set("video",v,`${i.value}.${v.name.split(".").pop()}`);const p=await _e({url:`${M.API_HOST}/queue-analysis/video-upload`,data:s,method:"post",responseType:"arraybuffer",onUploadProgress:function(u){const D=u.loaded/u.total*100|0;e.value=D,D===100&&(r.value="processing")}}),A=parseInt(p.headers["json-size"]),x=p.data,E=new Uint8Array(x,0,A),L=new Uint8Array(x,A),R=new Blob([L]);V.value=URL.createObjectURL(R),g.value=JSON.parse(new TextDecoder("utf-8").decode(E)),r.value="finished"}function o(){if(!v){alert("Please upload a video!");return}c.value=!c.value}const I=s=>{var p,A;(p=P.value)==null||p.clearFiles(),(A=P.value)==null||A.handleStart(s[0])},B=()=>{var s;if(!v){alert("Please upload a video!");return}if(!t.value){alert("Parameters must be set!");return}(s=P.value)==null||s.submit()};function w(s,p){c.value&&URL.revokeObjectURL(y.value),c.value=!1,v=s.raw,i.value=v.uid,y.value=URL.createObjectURL(v)}return(s,p)=>{const A=re,x=ve,E=G,L=K,R=pe;return q(),T("div",null,[r.value==="initial"?(q(),T("div",Ee,[l(x,{ref_key:"upload",ref:P,accept:"video/*",class:"upload-demo",drag:"",limit:1,"on-exceed":I,"on-change":w,"auto-upload":!1,"http-request":a,action:"#"},{default:f(()=>[k("div",null,[l(A,{class:"el-icon--upload"},{default:f(()=>[l(z(ge))]),_:1}),Re])]),_:1},512),Te,l(E,{type:"primary",round:"",onClick:B},{default:f(()=>[Ie]),_:1}),l(E,{type:"primary",round:"",onClick:o},{default:f(()=>[Le]),_:1}),l(L,{modelValue:c.value,"onUpdate:modelValue":p[0]||(p[0]=u=>c.value=u),width:"95%",title:"Preview","before-close":U},{default:f(()=>[k("video",{id:"videoPreview",ref_key:"videoElt",ref:_,src:y.value,controls:""},null,8,$e)]),_:1},8,["modelValue"]),l(xe,{"video-src":y.value,"video-uid":i.value,onParameterStatusChanged:C},null,8,["video-src","video-uid"])])):r.value==="uploading"?(q(),T("div",Ve,[l(R,{type:"circle",percentage:e.value,indeterminate:!0},null,8,["percentage"])])):r.value==="processing"?(q(),T("div",Be,[l(R,{type:"line",percentage:50,indeterminate:!0,"stroke-width":20,duration:5},{default:f(()=>[De]),_:1})])):r.value==="finished"?(q(),ue(he,{key:3,"results-video-src":V.value,"results-data":g.value},null,8,["results-video-src","results-data"])):de("",!0)])}}});var Me=Y(Oe,[["__scopeId","data-v-d2d0217a"]]);export{Me as default};
